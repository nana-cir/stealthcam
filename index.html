<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨¼æ‹ è¨˜éŒ²</title>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 0; user-select: none; height: 100vh; overflow: hidden; }
        
        /* 1. å¾…æ©Ÿç”»é¢ */
        #setup-screen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; position: relative;
        }

        /* éŒ²ç”»é–‹å§‹ãƒœã‚¿ãƒ³ï¼ˆã‚·ãƒ«ãƒãƒ¼ã‚°ãƒ¬ãƒ¼ï¼‰ */
        .rec-btn {
            width: 120px; height: 120px;
            background: #afafb0; border: 4px solid #fff; border-radius: 50%;
            box-shadow: 0 0 20px rgba(255,0,0,0.6);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; color: white; text-decoration: none;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .desc { color: #aaa; margin-top: 20px; font-size: 0.9rem; line-height: 1.5; }

        /* å³ä¸‹ã®ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ãƒœã‚¿ãƒ³ */
        .cam-switch {
            position: absolute; bottom: 30px; right: 30px;
            background: #333; color: #fff; border: 1px solid #666;
            padding: 10px 15px; border-radius: 30px; font-size: 0.9rem;
            cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .cam-switch:active { background: #555; }

        /* 2. éŒ²ç”»ä¸­ï¼ˆçœŸã£é»’ç”»é¢ï¼‰ */
        #black-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: none; cursor: default;
        }

        /* 3. ä¿å­˜ç”»é¢ */
        #save-screen { display: none; padding-top: 100px; }
        .save-link {
            background: #06C755; color: white; padding: 20px 40px; border-radius: 10px;
            text-decoration: none; font-weight: bold; font-size: 1.2rem; display: inline-block;
        }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h2 style="margin-bottom:30px;">ã‚¹ãƒ†ãƒ«ã‚¹</h2>
        
        <div class="rec-btn" onclick="startRecording()">é–‹å§‹</div>
        
        <p class="desc">
            é–‹å§‹ã™ã‚‹ã¨ç”»é¢ãŒæ¶ˆãˆã¾ã™ã€‚<br>
            çµ‚äº†ã¯ç”»é¢ã‚’<span style="color:#ff4444; font-weight:bold;">3å›ã‚¿ãƒƒãƒ—</span>
        </p>

        <button class="cam-switch" onclick="toggleCamera()">
            ğŸ”„ <span id="cam-label">å¤–ã‚«ãƒ¡ãƒ©</span>
        </button>
    </div>

    <div id="black-overlay"></div>

    <div id="save-screen">
        <h2>éŒ²ç”»çµ‚äº†</h2>
        <p>è¨¼æ‹ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™</p>
        <a id="download-btn" class="save-link">ğŸ“¥ å‹•ç”»ã‚’ä¿å­˜</a>
        <br><br><br>
        <button onclick="location.reload()" style="background:none; border:none; color:#666;">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
    </div>

    <script>
        let stream;
        let mediaRecorder;
        let recordedChunks = [];
        let useFrontCamera = false; // åˆæœŸå€¤ï¼šå¤–ã‚«ãƒ¡ãƒ©(false)

        // ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã®è¡¨ç¤ºã®ã¿æ›´æ–°ï¼ˆå®Ÿéš›ã¯é–‹å§‹æ™‚ã«é©ç”¨ï¼‰
        function toggleCamera() {
            useFrontCamera = !useFrontCamera;
            const label = document.getElementById('cam-label');
            label.innerText = useFrontCamera ? "å†…ã‚«ãƒ¡ãƒ©" : "å¤–ã‚«ãƒ¡ãƒ©";
        }

        async function startRecording() {
            // ã‚«ãƒ¡ãƒ©è¨­å®šï¼ˆç”»è³ªã¯HDãªã©ã‚’å„ªå…ˆçš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
            const constraints = {
                audio: true,
                video: {
                    facingMode: useFrontCamera ? "user" : "environment",
                    width: { ideal: 1280 }, // ãªã‚‹ã¹ãé«˜ç”»è³ª
                    height: { ideal: 720 }
                }
            };

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            // ç”»é¢ã‚’é»’ãã™ã‚‹
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('black-overlay').style.display = 'block';

            // ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼æº–å‚™
            setupRecorder();

            // ãƒˆãƒªãƒ—ãƒ«ã‚¿ãƒƒãƒ—æ¤œçŸ¥ã®é–‹å§‹
            setupTripleTap();
        }

        function setupRecorder() {
            recordedChunks = [];
            // ãƒ–ãƒ©ã‚¦ã‚¶ã«åˆã‚ã›ãŸå½¢å¼é¸æŠ
            let options = { mimeType: 'video/webm' };
            if (MediaRecorder.isTypeSupported('video/mp4')) {
                options = { mimeType: 'video/mp4' };
            } else if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9')) {
                options = { mimeType: 'video/webm; codecs=vp9' };
            }

            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                mediaRecorder = new MediaRecorder(stream);
            }

            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.onstop = saveVideo;
            mediaRecorder.start();
        }

        function saveVideo() {
            const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.getElementById('download-btn');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
            const now = new Date();
            const ext = mediaRecorder.mimeType.includes('mp4') ? 'mp4' : 'webm';
            a.href = url;
            a.download = `rec_${now.getTime()}.${ext}`;

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('black-overlay').style.display = 'none';
            document.getElementById('save-screen').style.display = 'block';
            
            // ã‚«ãƒ¡ãƒ©åœæ­¢
            stream.getTracks().forEach(track => track.stop());
        }

        // ãƒˆãƒªãƒ—ãƒ«ã‚¿ãƒƒãƒ—åˆ¤å®š
        function setupTripleTap() {
            let taps = 0;
            let timeout;
            const overlay = document.getElementById('black-overlay');

            const handleTap = (e) => {
                // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ãªã©ã‚’é˜²ã
                e.preventDefault();
                
                taps++;
                clearTimeout(timeout);
                
                // 500msä»¥å†…ã«æ¬¡ã®ã‚¿ãƒƒãƒ—ãŒãªã‘ã‚Œã°ãƒªã‚»ãƒƒãƒˆ
                timeout = setTimeout(() => { taps = 0; }, 500);

                if (taps === 3) {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    taps = 0;
                }
            };

            overlay.addEventListener('touchstart', handleTap);
            overlay.addEventListener('click', handleTap);
        }
    </script>
</body>
</html>
