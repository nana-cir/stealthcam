<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒœã‚¤ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼(æ˜ åƒä»˜)</title>
    <style>
        body { background: #000; color: white; font-family: sans-serif; text-align: center; padding: 20px; margin: 0; user-select: none; }
        
        /* é–‹å§‹å‰ã®ç”»é¢ */
        #start-screen { display: block; padding-top: 30px; }
        .btn-rec {
            background: #ff0000; color: white; border: 4px solid #fff;
            width: 200px; height: 200px; border-radius: 50%;
            font-size: 1.5rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
        }
        .instruction { color: #ccc; margin: 20px 0; font-size: 0.9rem; line-height: 1.6; }

        /* éŒ²ç”»ä¸­ã®æ“¬ä¼¼é›»æºã‚ªãƒ•ç”»é¢ */
        #stealth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: none;
        }

        /* å®Œäº†ãƒ»ä¿å­˜ç”»é¢ */
        #result-screen { display: none; padding-top: 50px; }
        .save-btn {
            background: #06C755; color: white; padding: 20px 40px;
            font-size: 1.2rem; border-radius: 10px; text-decoration: none;
            display: inline-block; font-weight: bold; margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h2>è¨¼æ‹ è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰</h2>
        <p class="instruction">
            ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ç”»é¢ãŒçœŸã£æš—ã«ãªã‚Šã¾ã™ã€‚<br>
            ã‚¹ãƒãƒ›ã®<b>å¤–ã‚«ãƒ¡ãƒ©</b>ã‚’ç›¸æ‰‹ã«å‘ã‘ã¦ãã ã•ã„ã€‚<br>
            <span style="color:yellow">çµ‚äº†æ™‚ã¯ç”»é¢ã‚’ã€Œãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã€ã—ã¾ã™ã€‚</span>
        </p>
        <button class="btn-rec" onclick="startStealth()">éŒ²ç”»é–‹å§‹<br><span style="font-size:0.8rem">(ç”»é¢OFF)</span></button>
    </div>

    <div id="stealth-overlay"></div>

    <div id="result-screen">
        <h2>éŒ²ç”»ã‚’çµ‚äº†ã—ã¾ã—ãŸ</h2>
        <p>è¨¼æ‹ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ</p>
        <a id="download-link" class="save-btn">ğŸ“¥ å‹•ç”»ã‚’ä¿å­˜ã™ã‚‹</a>
        <br><br><br>
        <button onclick="location.reload()" style="background:#333; color:#aaa; border:none; padding:10px;">æœ€åˆã«æˆ»ã‚‹</button>
    </div>

    <script>
        let mediaRecorder;
        let recordedChunks = [];
        let stream;

        async function startStealth() {
            try {
                // å¤–ã‚«ãƒ¡ãƒ© (environment) ã¨ãƒã‚¤ã‚¯ã‚’èµ·å‹•
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, 
                    audio: true 
                });
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã¾ãŸã¯ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚\nè¨­å®š > ãƒ–ãƒ©ã‚¦ã‚¶ > ã‚«ãƒ¡ãƒ©/ãƒã‚¤ã‚¯");
                return;
            }

            // ç”»é¢ã‚’çœŸã£æš—ã«ã™ã‚‹
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('stealth-overlay').style.display = 'block';

            // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—åˆ¤å®šã®æº–å‚™
            let lastTap = 0;
            const overlay = document.getElementById('stealth-overlay');
            overlay.addEventListener('click', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0) {
                    stopRecording(); // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æˆåŠŸ
                }
                lastTap = currentTime;
            });
            // å¿µã®ãŸã‚ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚‚ï¼ˆåå¿œãŒæ‚ªã„æ™‚ç”¨ï¼‰
            overlay.addEventListener('touchstart', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0) {
                    stopRecording();
                }
                lastTap = currentTime;
            });

            // éŒ²ç”»é–‹å§‹
            startRecordingLogic();
        }

        function startRecordingLogic() {
            recordedChunks = [];
            // iPhone(Safari)ã¨Android(Chrome)ã®ä¸¡å¯¾å¿œ
            let options = { mimeType: 'video/webm' };
            if (MediaRecorder.isTypeSupported('video/mp4')) {
                options = { mimeType: 'video/mp4' }; // Safariç”¨
            } else if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9')) {
                options = { mimeType: 'video/webm; codecs=vp9' }; // Chromeé«˜ç”»è³ª
            }

            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                // ã‚ªãƒ—ã‚·ãƒ§ãƒ³æŒ‡å®šã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                mediaRecorder = new MediaRecorder(stream);
            }

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                // éŒ²ç”»åœæ­¢å¾Œã®å‡¦ç†
                const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.getElementById('download-link');
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ (ä¾‹: rec_20250101_1200.mp4)
                const now = new Date();
                const ext = mediaRecorder.mimeType.includes('mp4') ? 'mp4' : 'webm';
                const filename = `rec_${now.getFullYear()}${now.getMonth()+1}${now.getDate()}_${now.getHours()}${now.getMinutes()}.${ext}`;
                
                a.href = url;
                a.download = filename;
                
                // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('stealth-overlay').style.display = 'none';
                document.getElementById('result-screen').style.display = 'block';

                // ã‚«ãƒ¡ãƒ©åœæ­¢
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }
    </script>
</body>
</html>
